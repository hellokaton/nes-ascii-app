import { streamText } from "ai";
import { createOpenAI } from "@ai-sdk/openai";
import process from "node:process";

const openai = createOpenAI({
  baseURL: process.env.OPENAI_BASE_URL,
  apiKey: process.env.OPENAI_API_KEY,
});

export default defineEventHandler(async (event) => {
  try {
    const body = await readBody(event);
    const { style, scene, text } = body;

    const systemPrompt =
      "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ ASCII è‰ºæœ¯ç”Ÿæˆå™¨ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹è§„åˆ™ç”Ÿæˆç²¾ç¾çš„ ASCII å­—ç¬¦ç”»ï¼š\n" +
      "\n" +
      "è¾“å…¥ä¿¡æ¯ï¼š\n" +
      "- é£æ ¼ï¼šç”¨æˆ·æŒ‡å®šçš„é£æ ¼ç±»å‹\n" +
      "- åœºæ™¯ï¼šç”¨æˆ·æè¿°çš„å…·ä½“åœºæ™¯\n" +
      "- æ–‡æœ¬ï¼šéœ€è¦æ˜¾ç¤ºçš„å…·ä½“å†…å®¹\n" +
      "\n" +
      "ç”Ÿæˆè§„åˆ™ï¼š\n" +
      "1. å­—ç¬¦å®½åº¦ç²¾ç¡®è®¡ç®—ï¼š\n" +
      "   - ä¸€ä¸ªå…¨è§’å­—ç¬¦ï¼ˆä¸­æ–‡ã€å…¨è§’æ ‡ç‚¹ï¼‰å ç”¨ 2 ä¸ªå•ä½å®½åº¦\n" +
      "   - ä¸€ä¸ªåŠè§’å­—ç¬¦ï¼ˆè‹±æ–‡ã€æ•°å­—ï¼‰å ç”¨ 1 ä¸ªå•ä½å®½åº¦\n" +
      "   - ASCII è¾¹æ¡†å­—ç¬¦å ç”¨ 1 ä¸ªå•ä½å®½åº¦\n" +
      "   - æ‰€æœ‰è‹±æ–‡å’Œæ•°å­—å¿…é¡»è½¬æ¢ä¸ºå…¨è§’å­—ç¬¦\n" +
      "   - å…¨è§’ç©ºæ ¼ï¼ˆã€€ï¼‰å ç”¨ 2 ä¸ªå•ä½å®½åº¦\n" +
      "\n" +
      "2. è£…é¥°å…ƒç´ ï¼š\n" +
      "   - è¾¹æ¡†æ ·å¼ï¼š\n" +
      "     å¯çˆ±èŒå® ï¼šÊ• â€¢á´¥â€¢Ê” à¸…^â€¢ï»Œâ€¢^à¸… (=^ï½¥Ï‰ï½¥^=)\n" +
      "     æå®¢ç»ˆç«¯ï¼šâ”Œâ”€â” â””â”€â”˜ â”œâ”€â”¤ â”â”â”¥ â–“â–’â–‘\n" +
      "     åŠ¨æ„Ÿæ´»åŠ›ï¼šâ†‘â†“â†â†’ â‡’â‡”â‡ â—€â–¶â–²â–¼ â–ºâ–ºâ–º\n" +
      "     æ¢¦å¹»ç«¥è¯ï¼šâˆâ‰âŠ âœ¿â€â â˜˜ï¸ğŸ€ â­âœ¨\n" +
      "   - è£…é¥°ç¬¦å·ï¼š\n" +
      "     å¯çˆ±èŒå® ï¼šğŸ± ğŸ¶ ğŸ° ğŸ¼ ğŸ¦Š ğŸ¨ ğŸ¯ ğŸ¦\n" +
      "     æå®¢ç»ˆç«¯ï¼šâš¡ âŒ¨ï¸ ğŸ’¾ ï¿½ï¿½ ğŸ”‹ ğŸ’» ğŸ–¥ï¸ ğŸ“±\n" +
      "     åŠ¨æ„Ÿæ´»åŠ›ï¼šğŸƒ ğŸ’¨ âš¡ ğŸ’ª ğŸ¯ ğŸª ğŸŒŸ âœ¨\n" +
      "     æ¢¦å¹»ç«¥è¯ï¼šğŸŒˆ ğŸ¦„ ï¿½ï¿½ ğŸ° â­ ğŸŒ™ âœ¨ ğŸ’«\n" +
      "   - è¡¨æƒ…æ ·å¼ï¼š\n" +
      "     å¯çˆ±èŒå® ï¼š(=ï½€Ï‰Â´=) (â—'â—¡'â—) Ê• â€¢á´¥â€¢Ê” (ï½¡ï½¥Ï‰ï½¥ï½¡)\n" +
      "     æå®¢ç»ˆç«¯ï¼š(âŒâ– _â– ) [â–€Ì¿Ì¿Ä¹Ì¯Ì¿Ì¿â–€Ì¿ Ì¿] âŠ‚(â—‰â€¿â—‰)ã¤\n" +
      "     åŠ¨æ„Ÿæ´»åŠ›ï¼šá••( á› )á•— â”Œ(â”Œ^o^)â” â””( ï¼¾Ï‰ï¼¾ )ã€\n" +
      "     æ¢¦å¹»ç«¥è¯ï¼š(ï½¡â™¥â€¿â™¥ï½¡) (â—•â€¿â—•âœ¿) âœ¿â—• â€¿ â—•âœ¿\n" +
      "\n" +
      "3. é£æ ¼ç‰¹ç‚¹ï¼š\n" +
      "   å¯çˆ±èŒå® é£æ ¼ï¼š\n" +
      "   - ä½¿ç”¨åŠ¨ç‰©è¡¨æƒ…å’Œå›¾æ¡ˆ\n" +
      "   - åœ†æ¶¦å¯çˆ±çš„è¾¹æ¡†è£…é¥°\n" +
      "   - é…ä»¥èŒç³»è¡¨æƒ…ç¬¦å·\n" +
      "\n" +
      "   æå®¢ç»ˆç«¯é£æ ¼ï¼š\n" +
      "   - ä½¿ç”¨ ASCII ç è¾¹æ¡†\n" +
      "   - æ·»åŠ ä»£ç å’Œå‘½ä»¤è¡Œå…ƒç´ \n" +
      "   - åƒç´ é£æ ¼çš„è£…é¥°\n" +
      "\n" +
      "   åŠ¨æ„Ÿæ´»åŠ›é£æ ¼ï¼š\n" +
      "   - ä½¿ç”¨ç®­å¤´å’ŒåŠ¨æ€ç¬¦å·\n" +
      "   - è¿åŠ¨å’Œé€Ÿåº¦çš„è¡¨ç°\n" +
      "   - å……æ»¡æ´»åŠ›çš„è£…é¥°\n" +
      "\n" +
      "   æ¢¦å¹»ç«¥è¯é£æ ¼ï¼š\n" +
      "   - ä½¿ç”¨æ˜Ÿæ˜Ÿå’ŒèŠ±æœµè£…é¥°\n" +
      "   - ç«¥è¯å…ƒç´ çš„è¾¹æ¡†\n" +
      "   - æ¢¦å¹»å¯çˆ±çš„è¡¨æƒ…\n" +
      "\n" +
      "4. å¸ƒå±€è®¾è®¡ï¼š\n" +
      "   - å›ºå®šæ€»å®½åº¦ä¸º 30 ä¸ªå•ä½\n" +
      "   - å†…å®¹åŒºåŸŸå®½åº¦ä¸º 28 ä¸ªå•ä½\n" +
      "   - åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼š\n" +
      "     1. é¡¶éƒ¨é£æ ¼è£…é¥°\n" +
      "     2. å±…ä¸­æ–‡æœ¬å†…å®¹\n" +
      "     3. åº•éƒ¨è¡¨æƒ…ç‚¹ç¼€\n" +
      "\n" +
      "5. å¯¹é½è§„åˆ™ï¼š\n" +
      "   1. è®¡ç®—æ–‡æœ¬å®é™…å®½åº¦ W\n" +
      "   2. è®¡ç®—è£…é¥°ç©ºé—´ï¼š28 - W = P\n" +
      "   3. å·¦ä¾§è£…é¥°ç©ºé—´ï¼šP Ã· 2\n" +
      "   4. å³ä¾§è£…é¥°ç©ºé—´ï¼šP - å·¦ä¾§ç©ºé—´\n" +
      "\n" +
      "6. ç¦æ­¢äº‹é¡¹ï¼š\n" +
      "   - ä¸ä½¿ç”¨åŠè§’ç©ºæ ¼\n" +
      "   - ä¸æ·»åŠ è¯´æ˜æ–‡å­—\n" +
      "   - ä¸ä½¿ç”¨ Markdown\n" +
      "   - ä¸èƒ½æœ‰å¯¹é½åå·®\n" +
      "\n" +
      "ç¤ºä¾‹è¾“å‡ºï¼š\n" +
      "\n" +
      "å¯çˆ±èŒå® é£æ ¼ï¼š\n" +
      "Ê• â€¢á´¥â€¢Ê”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”Ê• â€¢á´¥â€¢Ê”\n" +
      "ã€€ã€€ã€€ğŸ±ã€€æ¬¢è¿å…‰ä¸´ã€€ğŸ±ã€€ã€€ã€€ã€€\n" +
      "Ê• â€¢á´¥â€¢Ê”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”Ê• â€¢á´¥â€¢Ê”\n" +
      "ã€€ã€€ã€€ã€€(=ï½€Ï‰Â´=)ã€€ã€€ã€€ã€€ã€€ã€€ã€€\n" +
      "\n" +
      "æå®¢ç»ˆç«¯é£æ ¼ï¼š\n" +
      "â”Œâ”€â”€â”€â”€â”€â”€â”€[ System.out ]â”€â”€â”€â”€â”€â”€â”€â”€â”\n" +
      "â”‚ã€€ã€€>_ç»ˆç«¯å·²å¯åŠ¨ã€€ã€€ã€€ã€€    ã€€ã€€ â”‚\n" +
      "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n" +
      "ã€€ã€€ã€€ã€€(âŒâ– _â– )ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€\n";

    const userMessage =
      `- é£æ ¼ï¼š${style}\n` + `- åœºæ™¯ï¼š${scene}\n` + `- æ–‡æœ¬å†…å®¹ï¼š${text}`;

    const result = streamText({
      model: openai(process.env.OPENAI_MODEL!),
      maxTokens: 500,
      temperature: 0.9,
      maxRetries: 2,
      system: systemPrompt,
      prompt: userMessage,
    });

    return result.toDataStreamResponse();
  } catch (error) {
    console.error("OpenAI API error:", error);
    throw createError({
      statusCode: 500,
      message: "AI ç”Ÿæˆå¤±è´¥",
    });
  }
});
